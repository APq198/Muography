#ifndef GENERATOR_HH
#define GENERATOR_HH 1

#include "G4VUserPrimaryGeneratorAction.hh"
#include "G4ParticleGun.hh"
#include "G4SystemOfUnits.hh"
#include "G4ParticleTable.hh"
#include "Randomize.hh"
#include "math.h"
#include "G4GenericMessenger.hh"
#include "constructor.hh"

#include "globals.hh"
#ifdef ONE_THREADED
	#include <fstream>
#endif

#define INCLUDE_HELIUM 1
#define INCLUDE_HELIUM_NEW 1


class AccurateGenerator
{
	public:
		AccurateGenerator(G4double E_min, G4double E_max, G4double k, G4double b, G4String particleName, int length, G4double energies0_[], G4double fluxes0_[]);
		~AccurateGenerator();
		G4double generate_accurate_E();
	private:
		G4double energies0[100], fluxes0[100];
		// G4double *lg_energies0;
		G4String particleName;
		G4double E_min, E_max;		// should be same for every object of this class
		G4double k, b;
		G4double NC_Psi;
		int length;
		G4double phi_interpolated(G4double lgE);
		G4double Psi(G4double);
		G4double inverse_CDF(G4double);
		
		G4double my_lerp11(G4double x1, G4double x2, G4double y1, G4double y2, G4double x) {	
			G4double a = y1 + (x-x1)*(y2-y1)/(x2-x1);
			G4cout << G4endl << "aa" << a << G4endl;
			G4cout << G4endl << "bb " << x1 << " bb " << x2 << " oo " << x << G4endl;
			G4cout << G4endl << "cc " << y1 << " cc " << y2 <<  G4endl;
			return a;		}
};	


class AccurateGenerator_Protons
{
	public:
		AccurateGenerator_Protons(G4double E_min, G4double E_max);
		~AccurateGenerator_Protons();
		G4double generate_accurate_E();
	private:
		G4double E_min, E_max;
		G4double k = -2.6;
		G4double b = 27.7;
		G4double energies0[62] = {199921544.76111484, 240485460.88902575, 302953070.2457401, 381647033.5962363, 459082901.149991, 578332568.9900707, 728558087.2579212, 876381920.7579796, 1054199087.8478093, 1268095211.1129405, 1456544582.5280664, 1752076273.9864798, 2012449209.4022143, 2207189093.8715105, 2655025936.0148873, 3193728503.1375237, 3841733375.705851, 4412646532.26677, 5068402076.484144, 5821608284.521383, 6686747126.012868, 7680452710.314457, 8821831112.155489, 10132827726.011518, 11638649212.356182, 13368248148.594358, 15354879703.107552, 17636741035.637882, 22217995325.46859, 25519772050.509686, 29312219935.676872, 34454764327.90557, 40499518204.23605, 48716836961.05355, 59970402372.01342, 77312932946.73355, 101999017517.5311, 128493903143.87724, 154565209847.23392, 185926363123.77448, 223650668469.3146, 245292807379.31125, 295062515177.4548, 354930455536.01013, 407676038561.3912, 490393169700.62427, 563269625479.7191, 743122091047.5924, 936152722988.0698, 1179324274322.8462, 1354581554882.7917, 1960034024119.4404, 3110546343581.526, 4936393162825.432, 7833986305419.286, 11871307848915.094, 18839598072570.695, 29898176346968.05, 57075140782810.05, 108955531520501.83, 250196253568066.0, 601685613520239.0};
		G4double fluxes0[62] = {1492.49554505182, 1805.1850955720192, 1805.1850955720192, 1805.1850955720192, 1805.1850955720192, 1492.49554505182, 1492.49554505182, 1233.9692796398103, 1020.2242734613477, 843.5036311953877, 697.3940871117293, 576.5932649858903, 476.71725265692675, 394.1415080287651, 325.86932292753795, 222.75429519995427, 152.2680183094802, 125.89254117941584, 104.08575681597432, 71.14983758398104, 58.82544448529416, 40.21127336696097, 27.48719571845632, 18.78940568655321, 15.534752835119006, 10.619081562525311, 7.258879135601047, 4.9619476030028675, 2.804310428135217, 1.9169407765334439, 1.191480548089105, 0.8957233857950082, 0.6122890909287914, 0.346043291889239, 0.19557095110072745, 0.1005018168811834, 0.046961194001077754, 0.024132854564823503, 0.013639002490846559, 0.007708262959346138, 0.0052691326305264845, 0.0036018177927383435, 0.0024620924014946105, 0.0013914841406961597, 0.0009511759691218655, 0.0006501947796417433, 0.00036746619407366577, 0.00020767838809992954, 9.704128120312554e-05, 5.484416576120982e-05, 3.09959069042689e-05, 1.7517747448309716e-05, 4.626125296946266e-06, 1.477628358301306e-06, 3.9021534863390524e-07, 1.5075123182938445e-07, 3.981071705534953e-08, 8.692214496115054e-09, 1.2973091412086619e-09, 1.3235462760443923e-10, 1.975386920666182e-11, 2.9482561788479336e-12};
		int length = 62;
		G4double NC_Psi = pow(10, b) * (pow(E_max, (k+1)) - pow(E_min, (k+1))) / (k+1); //normalizing constant for Psi(x)
		G4double Psi(G4double E) { return pow(10, b) * pow(E, k) / NC_Psi; }
		G4double inverse_CDF(G4double y) {	return pow((y * (pow(E_max, (k+1)) - pow(E_min, (k+1))) + pow(E_min, (k+1))),  (1/(k+1)));	}
		G4double phi_interpolated(G4double lgE);
};



class AccurateGenerator_Alpha
{
	public:
		AccurateGenerator_Alpha(G4double E_min, G4double E_max);
		~AccurateGenerator_Alpha();
		G4double generate_accurate_E();
	private:
		G4double E_min, E_max;
		G4double k = -2.7;
		G4double b = 26.5;
		G4double energies0[57] = {2.0140290107538013, 2.5371856997767424, 3.196235625594224, 3.8447491912360126, 4.624845623126356, 5.563222976028452, 7.008305095945919, 8.430284405131696, 10.140782140394839, 12.774914012550095, 15.366933502823404, 18.484871604474925, 22.235436768900176, 26.746988504051473, 32.17393035591118, 38.70199422227376, 46.554596849424726, 58.647445868231635, 70.54696414255153, 88.87198130187436, 102.07908820203875, 122.79085079465382, 141.03858049585872, 161.99807281694356, 186.07231797241715, 223.8262374360644, 269.240395942248, 309.25173178693325, 371.9986524632697, 427.28070984321295, 513.9756125755048, 590.3566132004903, 678.0884583280767, 778.8579767490382, 936.8876162366342, 1076.1168167092542, 1236.0366207593947, 1486.8274291008397, 1707.7822059672492, 1961.572678802497, 2253.0785019188766, 3112.9881668557823, 3575.603795497607, 4301.090849134134, 5674.432777858529, 7840.136096477761, 11344.413665925818, 18854.38742594138, 31335.945221677146, 39475.65386641065, 47485.231395660376, 78920.3370142788, 119592.7053878722, 181225.9770178466, 287603.0687416792, 549029.6614584042, 1320336.5117757008, };
		G4double fluxes0[57] = {50.62299388226923, 74.05684692262398, 89.57233857950138, 89.57233857950138, 89.57233857950138, 74.05684692262398, 61.22890909287977, 50.62299388226923, 41.854208209341984, 34.60432918892454, 23.654460291311693, 19.557095110072783, 16.169465057924743, 11.05295141126013, 9.138387404950647, 6.246721929411474, 4.270067916167639, 2.918887732593866, 1.9952623149688666, 1.363900249084656, 0.9323204650824172, 0.6373057341948934, 0.4356426937402771, 0.2977920116300827, 0.2035615045653933, 0.13914841406961598, 0.09511759691218655, 0.053756970097504006, 0.03674661940736658, 0.025118864315095617, 0.017170486827250735, 0.011737219254280154, 0.008023203838600897, 0.004534419947930674, 0.00309959069042689, 0.002118785326128759, 0.0014483367988178699, 0.000990038706112178, 0.0006767601571680691, 0.00046261252969462664, 0.00031622776601683664, 0.0001221677348996783, 8.351012436296131e-05, 5.7084965001963284e-05, 2.667392689200085e-05, 1.2463848857844373e-05, 3.981071705534953e-06, 1.2715921145526467e-06, 4.0615859883769385e-07, 1.8978455660928563e-07, 1.297309141208662e-07, 3.425962529608272e-08, 4.227532514733751e-09, 1.116416089898579e-09, 3.56593902717452e-10, 6.437179983574068e-11, 6.567367271881885e-12, };
		int length = 57;
		G4double NC_Psi = pow(10, b) * (pow(E_max, (k+1)) - pow(E_min, (k+1))) / (k+1); //normalizing constant for Psi(x)
		G4double Psi(G4double E) { return pow(10, b) * pow(E, k) / NC_Psi; }
		G4double inverse_CDF(G4double y) {	return pow((y * (pow(E_max, (k+1)) - pow(E_min, (k+1))) + pow(E_min, (k+1))),  (1/(k+1)));	}
		G4double phi_interpolated(G4double lgE);
};


class PrimaryGenerator : public G4VUserPrimaryGeneratorAction
{
	public:
		PrimaryGenerator();
		~PrimaryGenerator();

		virtual void GeneratePrimaries(G4Event * anEvent);
	private:
		void MyGeneratePrimaries_Muons(G4Event * anEvent);
		void MyGeneratePrimaries_CosmicRays_Asteroid(G4Event * anEvent);
		void MyGeneratePrimaries_CosmicRays_Surface(G4Event * anEvent);
		G4ParticleGun * fParticleGun;
		void GenerateMuonFlux();

		G4GenericMessenger * fMessenger;

		G4double momentum;
		G4double energy;
		G4String particleName;
		G4bool useDistribution;
		G4bool launchVertically;
		static const unsigned int numOfPoints = 29;
		//G4double energies0[29];
		//G4double fluxes0[29];
		// G4double energies0[29] = {
		// 	282518489.9667483,
		// 	393149690.8141331,
		// 	547102879.5511398,
		// 	761342480.502315,
		// 	1059682816.9221555,
		// 	1475218971.877678,
		// 	2230891386.7257385,
		// 	3105696577.6373997,
		// 	3980916300.305746,
		// 	5102782642.757679,
		// 	6542080141.015659,
		// 	9109220692.97067,
		// 	11680859003.840343,
		// 	16267653489.799633,
		// 	20856128956.930878,
		// 	26741445395.695816,
		// 	32884848574.952053,
		// 	40455386058.19259,
		// 	51866284781.70766,
		// 	75284564450.58363,
		// 	941103449842.5316,
		// 	3543047381596.9365,
		// 	17091140465325.418,
		// 	36002103821286.086,
		// 	50158847134420.58,
		// 	89558429206492.34,
		// 	181058861289951.53,
		// 	297603041534441.9,
		// 	450224202888678.4	//29
		// };
		// G4double fluxes0[29] = {
		// 	4277.654199066912,
		// 	3633.153005079787,
		// 	3085.7568527160474,
		// 	2620.8352196482674,
		// 	1890.5829836907567,
		// 	1158.323286254708,
		// 	602.7564188857535,
		// 	369.29709087504904,
		// 	226.26111818250686,
		// 	138.62577005384486,
		// 	72.13665969982199,
		// 	37.53773681925604,
		// 	16.590449618912096,
		// 	7.332435087468232,
		// 	3.8155775399500476,
		// 	1.8298325446794785,
		// 	1.319980075832034,
		// 	0.6868777248548796,
		// 	0.3574304018221044,
		// 	0.14558631963371407,
		// 	0.0002495531870178878,
		// 	0.000004954906469324441,
		// 	8.355757272293554e-8,
		// 	1.632172128563277e-8,
		// 	5.203697672647922e-9,
		// 	1.1967796184265081e-9,
		// 	1.9855111964445867e-10,
		// 	5.3764604311936354e-11,
		// 	2.0182015668528597e-11
		// };
		
		// G4double proton_energies0[62] // proton_fluxes0[62]
		// G4double phi_interpolated(G4double E);
		///// G4double my_lerp(G4double x1, G4double x2, G4double y1, G4double y2, G4double x);
		G4double E_min_mes, E_max_mes;
		G4double E_min = 100e9;//1e11//pow(10, 10);
		G4double E_max = pow(10, 13);
		// G4double k = -2.6;	// from PCR_Fluxes.ipynb - manually
		// G4double b = 27.7;
		// G4double NC_Psi = pow(10, b) * (pow(E_max, (k+1)) - pow(E_min, (k+1))) / (k+1); //normalizing constant for Psi(x)
		// G4double Psi(G4double);
		// G4double inverse_CDF(G4double);
		// G4double generate_accurate_E();
		AccurateGenerator_Protons * ProtonGenerator = new AccurateGenerator_Protons(E_min, E_max);
		AccurateGenerator_Alpha * AlphaGenerator = new AccurateGenerator_Alpha(E_min, E_max);
};

G4double my_lerp(G4double x1, G4double x2, G4double y1, G4double y2, G4double x);

#endif